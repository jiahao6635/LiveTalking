<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ•°å­—äººæ˜¾ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        .video-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #video {
            max-width: 90%;
            max-height: 80vh;
            border-radius: 20px;
            box-shadow: 0 10px 50px rgba(102, 126, 234, 0.5);
        }

        #audio {
            display: none;
        }

        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
        }

        .control-btn {
            padding: 10px 20px;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: rgba(102, 126, 234, 1);
            transform: translateY(-2px);
        }

        .status-indicator {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background: rgba(0,0,0,0.8);
            color: white;
            border-radius: 10px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4444;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #44ff44;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .subtitle {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 20px 40px;
            background: rgba(0,0,0,0.85);
            color: white;
            border-radius: 15px;
            font-size: 24px;
            text-align: center;
            max-width: 80%;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            display: none;
        }

        .info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            max-width: 300px;
        }

        .info-panel div {
            margin-bottom: 5px;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
        }

        .loading-spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="video-container">
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div>æ­£åœ¨è¿æ¥æ•°å­—äºº...</div>
        </div>

        <div class="info-panel" id="infoPanel" style="display:none;">
            <div><strong>ğŸ“¡ è¿æ¥ä¿¡æ¯</strong></div>
            <div>ä¼šè¯ID: <span id="sessionInfo">-</span></div>
            <div>è¿æ¥çŠ¶æ€: <span id="connectionState">-</span></div>
            <div>è§†é¢‘çŠ¶æ€: <span id="videoState">-</span></div>
        </div>

        <div class="controls">
            <button class="control-btn" onclick="reconnect()">ğŸ”„ é‡æ–°è¿æ¥</button>
            <button class="control-btn" onclick="toggleInfo()">â„¹ï¸ ä¿¡æ¯</button>
            <button class="control-btn" onclick="openInputPage()">âŒ¨ï¸ è¾“å…¥é¡µé¢</button>
        </div>

        <audio id="audio" autoplay="true"></audio>
        <video id="video" autoplay="true" playsinline="true"></video>

        <div class="subtitle" id="subtitle"></div>

        <div class="status-indicator">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">æ­£åœ¨åˆå§‹åŒ–...</span>
        </div>
    </div>

    <script type="text/javascript">
        let pc = null;
        let sessionId = null;
        let currentSubtitle = '';

        function updateStatus(text, isConnected) {
            document.getElementById('statusText').textContent = text;
            const dot = document.getElementById('statusDot');
            if (isConnected) {
                dot.classList.add('connected');
            } else {
                dot.classList.remove('connected');
            }
        }

        function updateInfo(state, videoState) {
            document.getElementById('sessionInfo').textContent = sessionId || '-';
            document.getElementById('connectionState').textContent = state || '-';
            document.getElementById('videoState').textContent = videoState || '-';
        }

        function showSubtitle(text) {
            const subtitle = document.getElementById('subtitle');
            subtitle.textContent = text;
            subtitle.style.display = 'block';
            currentSubtitle = text;

            // 5ç§’åéšè—å­—å¹•
            setTimeout(() => {
                if (currentSubtitle === text) {
                    subtitle.style.display = 'none';
                }
            }, 5000);
        }

        function toggleInfo() {
            const panel = document.getElementById('infoPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function openInputPage() {
            window.open('/input.html', 'input_page', 'width=900,height=700');
        }

        async function start() {
            document.getElementById('loading').style.display = 'block';
            updateStatus('æ­£åœ¨å»ºç«‹è¿æ¥...', false);

            pc = new RTCPeerConnection({
                iceServers: [{urls: 'stun:stun.miwifi.com:3478'}]
            });

            pc.ontrack = function(event) {
                console.log('æ”¶åˆ°åª’ä½“æµ:', event.track.kind);
                console.log('Track çŠ¶æ€:', event.track.readyState);
                console.log('Streams:', event.streams.length);

                if (event.track.kind === 'audio') {
                    const audioElement = document.getElementById('audio');
                    audioElement.srcObject = event.streams[0];
                    console.log('éŸ³é¢‘æµå·²è¿æ¥, srcObject:', audioElement.srcObject);
                } else if (event.track.kind === 'video') {
                    const videoElement = document.getElementById('video');
                    videoElement.srcObject = event.streams[0];

                    // æ·»åŠ è§†é¢‘å…ƒæ•°æ®åŠ è½½äº‹ä»¶
                    videoElement.onloadedmetadata = function() {
                        console.log('è§†é¢‘å…ƒæ•°æ®å·²åŠ è½½');
                        console.log('è§†é¢‘å°ºå¯¸:', videoElement.videoWidth, 'x', videoElement.videoHeight);
                        document.getElementById('loading').style.display = 'none';
                    };

                    // æ·»åŠ æ’­æ”¾äº‹ä»¶
                    videoElement.onplay = function() {
                        console.log('è§†é¢‘å¼€å§‹æ’­æ”¾');
                        updateInfo('å·²è¿æ¥', 'æ’­æ”¾ä¸­');
                    };

                    // æ·»åŠ é”™è¯¯äº‹ä»¶
                    videoElement.onerror = function(e) {
                        console.error('è§†é¢‘é”™è¯¯:', e);
                    };

                    console.log('è§†é¢‘æµå·²è®¾ç½®, srcObject:', videoElement.srcObject);
                    console.log('Video readyState:', videoElement.readyState);
                }
            };

            pc.oniceconnectionstatechange = function() {
                console.log('ICEè¿æ¥çŠ¶æ€:', pc.iceConnectionState);
                updateInfo(pc.iceConnectionState, '-');

                if (pc.iceConnectionState === 'connected') {
                    updateStatus('âœ… æ•°å­—äººå·²è¿æ¥', true);
                } else if (pc.iceConnectionState === 'disconnected') {
                    updateStatus('âš ï¸ è¿æ¥å·²æ–­å¼€', false);
                } else if (pc.iceConnectionState === 'failed') {
                    updateStatus('âŒ è¿æ¥å¤±è´¥', false);
                }
            };

            // æ·»åŠ éŸ³é¢‘å’Œè§†é¢‘è½¨é“(ç”¨äºæ¥æ”¶)
            pc.addTransceiver('audio', {direction: 'recvonly'});
            pc.addTransceiver('video', {direction: 'recvonly'});

            try {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                const response = await fetch('/offer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sdp: pc.localDescription.sdp,
                        type: pc.localDescription.type
                    })
                });

                const answer = await response.json();
                sessionId = answer.sessionid;

                // å°†sessionIdä¿å­˜åˆ°localStorageä¾›è¾“å…¥é¡µé¢ä½¿ç”¨
                localStorage.setItem('sessionId', sessionId);

                console.log('è·å¾—ä¼šè¯ID:', sessionId);
                updateStatus('æ­£åœ¨å»ºç«‹åª’ä½“æµ...', false);

                await pc.setRemoteDescription(new RTCSessionDescription({
                    sdp: answer.sdp,
                    type: answer.type
                }));

                updateInfo('æ­£åœ¨è¿æ¥', 'åŠ è½½ä¸­');

            } catch (error) {
                console.error('è¿æ¥é”™è¯¯:', error);
                updateStatus('âŒ è¿æ¥å¤±è´¥: ' + error.message, false);
                document.getElementById('loading').innerHTML =
                    '<div style="color: #ff4444;">è¿æ¥å¤±è´¥,è¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
            }
        }

        async function stop() {
            if (pc) {
                pc.close();
                pc = null;
                sessionId = null;
                localStorage.removeItem('sessionId');
                updateStatus('å·²æ–­å¼€è¿æ¥', false);
                updateInfo('-', '-');
            }
        }

        async function reconnect() {
            await stop();
            setTimeout(start, 500);
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å¼€å§‹
        window.addEventListener('load', function() {
            start();
        });

        // é¡µé¢å…³é—­æ—¶æ–­å¼€è¿æ¥
        window.addEventListener('beforeunload', function() {
            stop();
        });

        // ç›‘å¬é”®ç›˜äº‹ä»¶:æŒ‰ç©ºæ ¼é”®æ˜¾ç¤º/éšè—ä¿¡æ¯é¢æ¿
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space') {
                e.preventDefault();
                toggleInfo();
            }
        });
    </script>
</body>
</html>
